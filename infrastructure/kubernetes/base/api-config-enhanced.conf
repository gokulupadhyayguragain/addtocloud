server {
    listen 80;
    server_name _;
    
    # CORS configuration
    add_header 'Access-Control-Allow-Origin' 'https://addtocloud.tech' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
    add_header 'Access-Control-Allow-Credentials' 'true' always;

    # Handle preflight requests
    location / {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'https://addtocloud.tech' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
            add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        
        # Default response for root
        return 200 '{"status":"healthy","message":"AddToCloud API Connected","frontend_connected":true,"version":"1.0.0","timestamp":"2025-08-30T10:30:00Z"}';
        add_header Content-Type application/json;
    }
    
    # Health check endpoint
    location /api/health {
        add_header Content-Type application/json;
        return 200 '{"status":"healthy","message":"AddToCloud API Connected","frontend_connected":true,"version":"1.0.0","database":"connected","timestamp":"2025-08-30T10:30:00Z"}';
    }
    
    # Contact form endpoint
    location /api/v1/contact {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'https://addtocloud.tech' always;
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        
        if ($request_method = 'POST') {
            # Log the contact request (in production, this would save to database)
            access_log /var/log/nginx/contact.log combined;
            add_header Content-Type application/json;
            return 200 '{"success":true,"message":"Contact request received and will be processed within 24 hours","request_id":"req_12345","timestamp":"2025-08-30T10:30:00Z"}';
        }
        
        return 405 '{"error":"Method not allowed","allowed_methods":["POST","OPTIONS"]}';
        add_header Content-Type application/json;
    }
    
    # Access request endpoint
    location /api/v1/access-request {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' 'https://addtocloud.tech' always;
            add_header 'Access-Control-Allow-Methods' 'POST, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        
        if ($request_method = 'POST') {
            # Log the access request (in production, this would save to database)
            access_log /var/log/nginx/access-requests.log combined;
            add_header Content-Type application/json;
            return 200 '{"success":true,"message":"Access request submitted successfully","status":"pending_review","estimated_response":"24-48 hours","request_id":"req_67890","timestamp":"2025-08-30T10:30:00Z"}';
        }
        
        return 405 '{"error":"Method not allowed","allowed_methods":["POST","OPTIONS"]}';
        add_header Content-Type application/json;
    }
    
    # API status endpoint
    location /api/status {
        add_header Content-Type application/json;
        return 200 '{"api_status":"operational","frontend_connection":"established","database_status":"connected","services":{"kubernetes":"running","istio":"active","monitoring":"operational"},"endpoints":["/api/health","/api/v1/contact","/api/v1/access-request"],"timestamp":"2025-08-30T10:30:00Z"}';
    }
    
    # Error handling
    error_page 404 = @404_json;
    location @404_json {
        add_header Content-Type application/json;
        return 404 '{"error":"Endpoint not found","available_endpoints":["/api/health","/api/v1/contact","/api/v1/access-request","/api/status"],"timestamp":"2025-08-30T10:30:00Z"}';
    }
}
