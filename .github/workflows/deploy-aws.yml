name: Deploy to AWS EKS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-west-2
  EKS_CLUSTER_NAME: addtocloud-${{ github.event.inputs.environment }}

jobs:
  deploy-aws:
    name: Deploy to AWS EKS
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-AddToCloud
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
      
      - name: Check cluster connectivity
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace addtocloud --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy secrets
        run: |
          kubectl create secret generic addtocloud-secrets \
            --from-literal=database-password="${{ secrets.DATABASE_PASSWORD }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --from-literal=api-key="${{ secrets.API_KEY }}" \
            --namespace=addtocloud \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy configmap
        run: |
          kubectl create configmap addtocloud-config \
            --from-literal=database-name="addtocloud" \
            --from-literal=database-host="postgres-service" \
            --from-literal=redis-host="redis-service" \
            --from-literal=mongodb-host="mongodb-service" \
            --from-literal=environment="${{ github.event.inputs.environment }}" \
            --namespace=addtocloud \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy applications
        run: |
          kubectl apply -k infrastructure/kubernetes/environments/${{ github.event.inputs.environment }}
      
      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available --timeout=600s deployment/addtocloud-frontend -n addtocloud
          kubectl wait --for=condition=available --timeout=600s deployment/addtocloud-backend -n addtocloud
      
      - name: Check deployment status
        run: |
          kubectl get pods -n addtocloud
          kubectl get services -n addtocloud
          kubectl get ingress -n addtocloud
      
      - name: Run health check
        run: |
          # Wait for ingress to be ready
          sleep 60
          
          # Get ingress IP
          INGRESS_IP=$(kubectl get ingress addtocloud-ingress -n addtocloud -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [ -n "$INGRESS_IP" ]; then
            echo "Testing health endpoint: http://$INGRESS_IP/api/health"
            curl -f http://$INGRESS_IP/api/health || echo "Health check failed"
          else
            echo "Ingress IP not yet available"
          fi
      
      - name: Deploy monitoring (optional)
        if: github.event.inputs.environment == 'prod'
        run: |
          kubectl apply -k infrastructure/kubernetes/monitoring
          kubectl wait --for=condition=available --timeout=300s deployment/prometheus -n monitoring
          kubectl wait --for=condition=available --timeout=300s deployment/grafana -n monitoring
      
      - name: Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to AWS EKS (${{ github.event.inputs.environment }}) completed successfully"
          else
            echo "❌ Deployment to AWS EKS (${{ github.event.inputs.environment }}) failed"
          fi
