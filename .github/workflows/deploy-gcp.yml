name: Deploy to GCP GKE

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: false
        type: boolean

env:
  GCP_PROJECT_ID: addtocloud-${{ github.event.inputs.environment }}
  GCP_REGION: us-central1
  GKE_CLUSTER_NAME: addtocloud-${{ github.event.inputs.environment }}

jobs:
  deploy-gcp:
    name: Deploy to GCP GKE
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'
      
      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'
      
      - name: Configure kubectl for GKE
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER_NAME }} \
            --region ${{ env.GCP_REGION }} \
            --project ${{ env.GCP_PROJECT_ID }}
      
      - name: Check cluster connectivity
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Create namespace if not exists
        run: |
          kubectl create namespace addtocloud --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy secrets
        run: |
          kubectl create secret generic addtocloud-secrets \
            --from-literal=database-password="${{ secrets.DATABASE_PASSWORD }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --from-literal=api-key="${{ secrets.API_KEY }}" \
            --namespace=addtocloud \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy configmap
        run: |
          kubectl create configmap addtocloud-config \
            --from-literal=database-name="addtocloud" \
            --from-literal=database-host="postgres-service" \
            --from-literal=redis-host="redis-service" \
            --from-literal=mongodb-host="mongodb-service" \
            --from-literal=environment="${{ github.event.inputs.environment }}" \
            --namespace=addtocloud \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy applications
        run: |
          kubectl apply -k infrastructure/kubernetes/environments/${{ github.event.inputs.environment }}
      
      - name: Wait for deployment
        run: |
          kubectl wait --for=condition=available --timeout=600s deployment/addtocloud-frontend -n addtocloud
          kubectl wait --for=condition=available --timeout=600s deployment/addtocloud-backend -n addtocloud
      
      - name: Check deployment status
        run: |
          kubectl get pods -n addtocloud
          kubectl get services -n addtocloud
          kubectl get ingress -n addtocloud
      
      - name: Configure Cloud DNS (if production)
        if: github.event.inputs.environment == 'prod'
        run: |
          # Get ingress IP
          INGRESS_IP=$(kubectl get ingress addtocloud-ingress -n addtocloud -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          
          if [ -n "$INGRESS_IP" ]; then
            echo "Configuring DNS for IP: $INGRESS_IP"
            # Configure Cloud DNS
            gcloud dns record-sets transaction start --zone=addtocloud-zone
            gcloud dns record-sets transaction add $INGRESS_IP --name=addtocloud.tech. --ttl=300 --type=A --zone=addtocloud-zone
            gcloud dns record-sets transaction execute --zone=addtocloud-zone
          fi
      
      - name: Run health check
        run: |
          # Wait for ingress to be ready
          sleep 60
          
          # Get ingress IP
          INGRESS_IP=$(kubectl get ingress addtocloud-ingress -n addtocloud -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          
          if [ -n "$INGRESS_IP" ]; then
            echo "Testing health endpoint: http://$INGRESS_IP/api/health"
            curl -f http://$INGRESS_IP/api/health || echo "Health check failed"
          else
            echo "Ingress IP not yet available"
          fi
      
      - name: Deploy monitoring (optional)
        if: github.event.inputs.environment == 'prod'
        run: |
          kubectl apply -k infrastructure/kubernetes/monitoring
          kubectl wait --for=condition=available --timeout=300s deployment/prometheus -n monitoring
          kubectl wait --for=condition=available --timeout=300s deployment/grafana -n monitoring
      
      - name: Configure Google Cloud Monitoring
        if: github.event.inputs.environment == 'prod'
        run: |
          # Enable Google Cloud Monitoring
          gcloud services enable monitoring.googleapis.com
          gcloud services enable logging.googleapis.com
          
          # Create monitoring dashboard
          echo "Google Cloud Monitoring enabled for cluster"
      
      - name: Setup Cloud Armor (security)
        if: github.event.inputs.environment == 'prod'
        run: |
          # Create Cloud Armor security policy
          gcloud compute security-policies create addtocloud-security-policy \
            --description "Security policy for AddToCloud"
          
          # Add rate limiting rule
          gcloud compute security-policies rules create 1000 \
            --security-policy addtocloud-security-policy \
            --expression "true" \
            --action "rate-based-ban" \
            --rate-limit-threshold-count 100 \
            --rate-limit-threshold-interval-sec 60 \
            --ban-duration-sec 300
      
      - name: Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Deployment to GCP GKE (${{ github.event.inputs.environment }}) completed successfully"
          else
            echo "❌ Deployment to GCP GKE (${{ github.event.inputs.environment }}) failed"
          fi
